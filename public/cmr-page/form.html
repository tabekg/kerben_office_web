<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <title>CMR Form</title>
</head>
<body>
<h1>CMR form</h1>
<div style='display: flex; gap: 12px; flex-direction: column'>
  <div><textarea id="textarea"></textarea></div>

  <div>
    Truck number
    <input id='truckNumber' type='text' />
  </div>
  <div>
    Invoice
    <input id='invoice' type='text' />
  </div>
  <div>
    Weight
    <input id='weight' type='text' /> <button onclick="weight.value += '.000';">.000</button>
  </div>
  <div>
    Quantity
    <input id='quantity' type='text' />
  </div>
  <div>
    Date
    <input id='date' type='text' /> <span style="gap: 4px; display: inline-flex;" id="dateButtons"></span>
  </div>
  <div>
    Container
    <input id='container' type='text' />
  </div>
  <p id='link'></p>
  <button onclick='copy()'>Copy and show</button>
</div>

<script type='text/javascript'>
  function tap(s) {
      const r = s.split('\n').map(l => l.split('\t'))
      const invoice = r[1][2].split('№')[1].trim().replace(' от ', '_')
      const truckNumber = r[19][2];
      const quantity = r.find(k => k[0].startsWith('Итого'))[4]
      const weight = r.find(k => k[0].startsWith('Итого'))[6]

      return {invoice, truckNumber, quantity, weight}
  }

  const textarea = document.getElementById('textarea')

  textarea.oninput = (e) => {
    try {
      const t = tap(e.target.value)
      document.getElementById('truckNumber').value = t.truckNumber + '/'
      document.getElementById('invoice').value = t.invoice
      document.getElementById('quantity').value = t.quantity
      document.getElementById('weight').value = t.weight
    } catch (e) {
      window.alert('Ката!!!')
    }
  }

  const dateButtons = document.getElementById('dateButtons')

  for (let i = 0; i < 3; i++) {
    const date = new Date()
    date.setDate(new Date().getDate() - i);
    const t = `${date.getDate()}.${(date.getMonth()+1).toString().padStart(2, '0')}.${date.getFullYear()}`
    dateButtons.innerHTML += `<button onClick="date.value = '${t}';">${t}</button>`
  }

  function copy() {
    try {
      const truckNumber = document.getElementById('truckNumber').value.toUpperCase()
      const invoice = document.getElementById('invoice').value
      const weight = document.getElementById('weight').value
      const quantity = document.getElementById('quantity').value
      const date = document.getElementById('date').value
      const container = document.getElementById('container').value.toUpperCase()

      const object = {truckNumber, invoice, weight, quantity, date, container}

      const url = 'https://office.kerben.besoft.kg/cmr-page/cmr.html?' + Object.entries(object)
        .map(([key, value]) => `${encodeURIComponent(key)}=${encodeURIComponent(value)}`)
        .join('&')

      setClipboard(url).then(res => {
        //window.alert('Copied!')
      })
    } catch (e) {
      window.alert('Error: ' + e.toString())
    }
  }

  async function setClipboard(text) {
    try {
      const type = 'text/plain'
      const clipboardItemData = {
        [type]: text,
      }
      const clipboardItem = new ClipboardItem(clipboardItemData)
      await navigator.clipboard.write([clipboardItem])
    } catch (e) {
      //window.alert('Error: ' + e.toString())
      document.getElementById('link').innerHTML = text
    }
  }
</script>
</body>
</html>
